# FlowMaster - 技术架构文档

本文档详细说明了FlowMaster应用的技术架构，包括系统组件、数据流和技术选择的理由。

## 1. 系统架构概览

FlowMaster采用现代化的前后端分离架构，由以下主要组件组成：

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端 (浏览器)                           │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      前端应用 (Vue.js 3)                         │
│                                                                 │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────────────┐    │
│  │   视图层    │   │   状态管理  │   │      服务层        │    │
│  │  (Vue组件)  │◄──┤   (Pinia)   │◄──┤    (API服务)      │    │
│  └─────────────┘   └─────────────┘   └─────────────────────┘    │
│                                                │                │
└────────────────────────────────────────────────┼────────────────┘
                                                │
                                                ▼
┌────────────────────────────────────────────────┼────────────────┐
│                     后端API (FastAPI)           │                │
│                                                │                │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────┴───────┐        │
│  │  API路由    │   │  业务逻辑   │   │   数据访问层   │        │
│  │ (Endpoints) │──►│  (Services) │──►│    (Models)    │        │
│  └─────────────┘   └─────────────┘   └─────────────────┘        │
│                                                │                │
└────────────────────────────────────────────────┼────────────────┘
                                                │
                                                ▼
┌────────────────────────────────────────────────┼────────────────┐
│                     数据库 (MongoDB)            │                │
│                                                │                │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────┴───────┐        │
│  │  用户集合   │   │  任务集合   │   │  每日卡片集合  │        │
│  │   (Users)   │   │   (Tasks)   │   │ (Daily Cards)  │        │
│  └─────────────┘   └─────────────┘   └─────────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 前端架构

### 2.1 技术栈

- **框架**: Vue.js 3 (Composition API)
- **构建工具**: Vite
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **UI框架**: Tailwind CSS
- **HTTP客户端**: Axios

### 2.2 模块结构

```
前端应用
│
├── 核心模块
│   ├── 认证模块 (登录/注册)
│   ├── 导航模块 (菜单/路由)
│   └── 布局模块 (页面结构)
│
├── 功能模块
│   ├── 任务管理模块
│   │   ├── 任务列表 (待办/关注/稍后)
│   │   ├── 任务创建与编辑
│   │   └── 任务拖放功能
│   │
│   └── 每日卡片模块
│       ├── 卡片创建
│       ├── 任务选择
│       └── 成就记录
│
└── 共享模块
    ├── UI组件 (按钮/表单/卡片等)
    ├── 工具函数
    └── API服务
```

### 2.3 状态管理

使用Pinia进行状态管理，主要存储包括：

- **AuthStore**: 管理用户认证状态
- **TaskStore**: 管理任务数据和操作
- **DailyCardStore**: 管理每日卡片数据
- **UIStore**: 管理UI状态(主题/通知等)

### 2.4 数据流

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   用户操作  │      │  状态更新   │      │   UI更新    │
│  (事件触发) │─────►│ (Store操作) │─────►│ (组件渲染)  │
└─────────────┘      └──────┬──────┘      └─────────────┘
                            │
                            ▼
                     ┌─────────────┐
                     │   API调用   │
                     │ (异步操作)  │
                     └──────┬──────┘
                            │
                            ▼
                     ┌─────────────┐
                     │  后端处理   │
                     └─────────────┘
```

## 3. 后端架构

### 3.1 技术栈

- **框架**: FastAPI (Python 3.9+)
- **数据库**: MongoDB
- **ORM**: Motor (异步MongoDB驱动)
- **认证**: PyJWT
- **API文档**: Swagger UI (FastAPI内置)

### 3.2 模块结构

```
后端应用
│
├── API模块
│   ├── 认证API (注册/登录)
│   ├── 任务API (CRUD操作)
│   └── 每日卡片API (创建/更新)
│
├── 服务模块
│   ├── 用户服务
│   ├── 任务服务
│   └── 每日卡片服务
│
├── 数据访问模块
│   ├── 数据库连接
│   ├── 模型定义
│   └── 查询操作
│
└── 核心模块
    ├── 配置管理
    ├── 安全功能
    └── 工具函数
```

### 3.3 API设计原则

1. **RESTful设计**: 遵循REST原则设计API
2. **JWT认证**: 使用JWT进行API认证
3. **输入验证**: 使用Pydantic进行请求验证
4. **异步处理**: 利用FastAPI的异步特性提高性能
5. **文档自动生成**: 利用FastAPI自动生成Swagger文档

## 4. 数据库设计

### 4.1 集合设计

#### 用户集合 (Users)

```json
{
  "_id": "ObjectId",
  "username": "String",
  "email": "String",
  "password": "String (hashed)",
  "preferences": {
    "theme": "String"
  },
  "created_at": "Date",
  "last_login": "Date"
}
```

#### 任务集合 (Tasks)

```json
{
  "_id": "ObjectId",
  "user_id": "ObjectId (ref: users)",
  "title": "String",
  "description": "String",
  "list_type": "String (todo, watch, later)",
  "priority": "Number (1-5, optional)",
  "due_date": "Date (optional)",
  "is_completed": "Boolean",
  "completed_at": "Date",
  "created_at": "Date",
  "updated_at": "Date"
}
```

#### 每日卡片集合 (Daily Cards)

```json
{
  "_id": "ObjectId",
  "user_id": "ObjectId (ref: users)",
  "date": "Date",
  "tasks": [
    {
      "task_id": "ObjectId (ref: tasks)",
      "title": "String",
      "is_completed": "Boolean"
    }
  ],
  "accomplishments": [
    {
      "title": "String",
      "source": "String (manual, task)",
      "task_id": "ObjectId (optional, ref: tasks)"
    }
  ],
  "created_at": "Date",
  "updated_at": "Date"
}
```

### 4.2 索引设计

- **用户集合**: 
  - `email`: 唯一索引
  - `username`: 唯一索引

- **任务集合**:
  - `user_id`: 索引
  - `list_type`: 索引
  - `(user_id, list_type)`: 复合索引

- **每日卡片集合**:
  - `user_id`: 索引
  - `date`: 索引
  - `(user_id, date)`: 唯一复合索引

## 5. 安全考虑

### 5.1 认证与授权

- **密码安全**: 使用bcrypt哈希存储密码
- **JWT认证**: 使用安全的JWT实现，包含过期时间
- **HTTPS**: 所有生产环境通信使用HTTPS
- **CORS**: 正确配置CORS策略

### 5.2 数据安全

- **输入验证**: 所有用户输入经过验证
- **XSS防护**: 前端实施XSS防护措施
- **CSRF防护**: 实施CSRF令牌验证
- **敏感数据**: 敏感数据加密存储

## 6. 性能考虑

### 6.1 前端性能

- **代码分割**: 按路由分割代码
- **懒加载**: 组件和路由懒加载
- **缓存策略**: 实施有效的API响应缓存
- **资源优化**: 优化图片和静态资源

### 6.2 后端性能

- **异步处理**: 使用FastAPI的异步特性
- **数据库索引**: 优化数据库查询
- **连接池**: 使用数据库连接池
- **缓存**: 实施适当的缓存策略

## 7. 可扩展性考虑

### 7.1 水平扩展

- **无状态API**: 设计无状态API便于扩展
- **负载均衡**: 支持多实例部署
- **分布式缓存**: 使用Redis等分布式缓存

### 7.2 功能扩展

- **模块化设计**: 便于添加新功能
- **插件架构**: 为未来功能预留扩展点
- **API版本控制**: 支持API版本管理

## 8. 部署架构

### 8.1 开发环境

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  前端开发   │    │  后端开发   │    │  本地数据库 │
│  (Vite Dev) │    │ (FastAPI)   │    │ (MongoDB)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 8.2 生产环境

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  CDN        │    │  负载均衡   │    │             │
│ (Cloudflare)│───►│  (Nginx)    │───►│  API服务器  │
└─────────────┘    └─────────────┘    │  (FastAPI)  │
                                      └──────┬──────┘
                                             │
                                             ▼
                                      ┌─────────────┐
                                      │  数据库     │
                                      │ (MongoDB)   │
                                      └─────────────┘
```

## 9. 技术选择理由

### 9.1 前端技术

- **Vue.js 3**: 提供响应式编程模型，Composition API提高代码复用性
- **Vite**: 提供快速的开发体验和优化的构建
- **Tailwind CSS**: 提供高度可定制的UI，减少CSS维护成本
- **Pinia**: 提供类型安全的状态管理，与Vue 3集成良好

### 9.2 后端技术

- **FastAPI**: 提供高性能的异步API开发，自动生成API文档
- **MongoDB**: 提供灵活的文档存储，适合快速迭代开发
- **JWT**: 提供无状态认证，便于系统扩展

---

本架构文档提供了FlowMaster应用的技术架构概览，为开发团队提供了清晰的实施指南。随着项目的发展，架构可能需要调整以适应新的需求和挑战。
